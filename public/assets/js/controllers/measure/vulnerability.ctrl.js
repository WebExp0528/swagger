(function () {
    VulnerabilityController.$inject = ['$scope', '$rootScope', '$state', '$filter', 'MeasureService', 'OwaspService', 'Utils'];
    app.controller('VulnerabilityCtrl', VulnerabilityController);

    function VulnerabilityController($scope, $rootScope, $state, $filter, MeasureService, OwaspService, Utils) {
        $scope.mainTitle = $state.current.title;
        $scope.mainDesc = "Add Edit Search & Delete Vulnerabilities";

        $scope.OpList = [5, 10, 25, 50, 100];
        $scope.Grid1 = {
            PerPage: 10,
            CurrPage: 1,
            Column: 'sn',
            IsAsc: false,
            Filter: "",
            Total: 0,
            Data: [],
            SortMe: function(col){
                if($scope.Grid1.Column === col)
                    $scope.Grid1.IsAsc = !$scope.Grid1.IsAsc;
                else
                    $scope.Grid1.Column = col;
            },
            GetIco: function(col){
                if($scope.Grid1.Column === col){
                    return $scope.Grid1.IsAsc? 'fa-sort-up' : 'fa-sort-down';
                } else {
                    return 'fa-unsorted';
                }
            }
        };
        $scope.$watch('Grid1.Filter', function(n, o){
            var searchedData = $filter('filter')($scope.Grid1.Data, $scope.Grid1.Filter);
            $scope.Grid1.Total = searchedData.length;
        });

        loadOwasp();

        $scope.OpList2 = [5, 10, 25, 50, 100];
        $scope.Grid2 = {
            PerPage: 10,
            CurrPage: 1,
            Column: 'filename',
            IsAsc: true,
            Filter: "",
            Total: 0,
            Data: [],
            SortMe: function(col){
                if($scope.Grid2.Column === col)
                    $scope.Grid2.IsAsc = !$scope.Grid2.IsAsc;
                else
                    $scope.Grid2.Column = col;
            },
            GetIco: function(col){
                if($scope.Grid2.Column === col){
                    return $scope.Grid2.IsAsc? 'fa-sort-up' : 'fa-sort-down';
                } else {
                    return 'fa-unsorted';
                }
            }
        };
        $scope.$watch('Grid2.Filter', function(n, o){
            var searchedData = $filter('filter')($scope.Grid2.Data, $scope.Grid2.Filter);
            $scope.Grid2.Total = searchedData.length;
        });

        loadFiles();

        $scope.OpList3 = [5, 10, 25, 50, 100];
        $scope.Grid3 = {
            PerPage: 10,
            CurrPage: 1,
            Column: 'issue',
            IsAsc: true,
            Filter: "",
            Total: 0,
            Data: [],
            SortMe: function(col){
                if($scope.Grid3.Column === col)
                    $scope.Grid3.IsAsc = !$scope.Grid3.IsAsc;
                else
                    $scope.Grid3.Column = col;
            },
            GetIco: function(col){
                if($scope.Grid3.Column === col){
                    return $scope.Grid3.IsAsc? 'fa-sort-up' : 'fa-sort-down';
                } else {
                    return 'fa-unsorted';
                }
            }
        };
        $scope.$watch('Grid3.Filter', function(n, o){
            var searchedData = $filter('filter')($scope.Grid3.Data, $scope.Grid3.Filter);
            $scope.Grid3.Total = searchedData.length;
        });

        loadVulnerabilities();

        $scope.deleteVulnerability = function(p){
            var confirmation = Utils.CreateConfirmModal("Confirm Deletion", "Are you sure you want to delete the selected item", "Yes", "No");
            confirmation.result.then(function () {
                $rootScope.app.Mask = true;
                MeasureService.DeleteVuln(p.id).then(function(data){
                    if(data.status===200) loadVulnerabilities();
                }, function(err){
                    $rootScope.app.Mask = false
                });
            });
        };

        $scope.downloadFile = function(p){
            $rootScope.app.Mask = true;
            console.log("File: ", p);
            MeasureService.FileDownloadVuln(p.id).then(function(data){
                if(data.status===200) {
                    loadFiles();
                }
            }, function(err){
                $rootScope.app.Mask = false
            });
        };

        $scope.uploadFile = function() {
            var fileModel = $scope.VM.files;
            var d = new Date();
            var idd = 'Vulner' + d.getTime();
            $scope.VM.key = idd;

            MeasureService.FileUploadVuln(idd, fileModel).then(function(res){
                if(res.status === 200) {
                    for (var i in fileModel) {
                        fileModel[i].id = res.data.fileId;
                        fileModel[i].filePath = res.data.path;
                    }

                    loadFiles();
                }
            })
        };

        function loadOwasp(){
            OwaspService.Get()
                .then(function(data) {
                    $scope.Grid1.Total = data.length;
                    $scope.Grid1.Data = data;
                    $rootScope.app.Mask = false;
                });
        }

        function loadFiles(){
            MeasureService.GetFilesVuln("Vulner")
                .then(function(data) {
                    $scope.Grid2.Total = data.length;
                    $scope.Grid2.Data = data;
                    $rootScope.app.Mask = false;
                });
        }

        function loadVulnerabilities(){
            MeasureService.GetVuln($scope.PerPage, $scope.CurrPage)
                .then(function(data) {
                    $scope.Grid3.Total = data.length;
                    $scope.Grid3.Data = data;
                    $rootScope.app.Mask = false;
                });
        }
    }
})();